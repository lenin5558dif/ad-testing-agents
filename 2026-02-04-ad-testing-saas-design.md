# Ad Testing SaaS — Дизайн-документ

**Дата:** 2026-02-04
**Статус:** Validated design (v3 — final)

---

## 1. Суть продукта

SaaS-платформа для тестирования рекламных офферов через AI-персоны. Маркетолог загружает офферы, AI генерирует целевые персоны (или берёт из библиотеки), прогоняет каждый оффер через каждую персону и выдаёт интерактивный отчёт: heatmap решений, победители, инсайты, рекламная стратегия.

**Проблема:** Маркетологи тратят бюджет на A/B-тесты реальных кампаний, чтобы понять какой оффер работает. Это дорого (10-50к₽ на тест), долго (3-7 дней), и даёт только CTR без понимания «почему».

**Решение:** Предварительный тест офферов через AI-симуляцию за 2 минуты и ~50₽. Не замена A/B-теста, а фильтр: из 10 гипотез оставить 2-3 лучших для реального теста.

**ICP (Ideal Customer Profile):**
- **Первичный:** SMM-специалисты и маркетологи малого бизнеса (бьюти, услуги, локальный бизнес). Бюджет на рекламу 50-300к₽/мес. Запускают 5-15 креативов в месяц. Боль: каждый неудачный креатив = 5-10к₽ слив
- **Вторичный:** Маркетинговые агентства. Делают креативы для клиентов, нужен инструмент обоснования решений. Готовы платить за Agency-тариф

---

## 2. Валидация спроса (до написания кода)

**Шаг 1: Лендинг с waitlist**
- Одностраничный лендинг: проблема → решение → пример отчёта (скриншот нашего report.html) → форма email
- Цель: 50 email за 2 недели = сигнал к старту
- Трафик: посты в маркетинговых Telegram-чатах, 2-3 поста в свой канал

**Шаг 2: Ручной тест с 3-5 людьми из waitlist**
- Прогнать их офферы через текущий эксперимент вручную (через Claude)
- Отправить им report.html
- Собрать обратную связь: «заплатили бы 1990₽/мес за это?»

**Шаг 3: Принять решение go/no-go**
- Go: ≥30% из waitlist подтвердили готовность платить
- No-go: переформулировать ценностное предложение и повторить

---

## 3. Core Product Flow

### Шаг 1: Создать проект
Пользователь описывает нишу/продукт в свободной форме.
> Пример: «Студия лазерной эпиляции в Москве, средний чек 3000₽, ЦА — женщины 20-45»

### Шаг 2: Сгенерировать персоны
AI создаёт 6-10 персон на основе ниши. Каждая персона включает:
- Имя, возраст, социальный контекст
- Психотип, паттерн принятия решений
- Боли и триггеры покупки
- Бюджет и ценовая чувствительность
- Предыдущий опыт с продуктом/нишей

Альтернатива: выбрать готовый набор из библиотеки персон.
Пользователь может редактировать, удалять, добавлять персоны.

### Шаг 3: Загрузить офферы
Ввести 1-10 рекламных текстов вручную.
Либо: описать продукт → AI сгенерирует 5-7 вариантов с разными стратегиями (цена, FOMO, доверие, ниша, гарантия, соцдоказательство).

### Шаг 4: Прогнать тест
Каждый оффер × каждая персона. На каждую пару AI генерирует:
- **Решение:** strong_yes / maybe_yes / neutral / probably_not / strong_no / not_for_me
- **Confidence:** 0.0–1.0
- **Perceived value:** 0–10
- **Эмоция:** excited, skeptical, annoyed, etc. + intensity
- **Первая реакция:** фраза от лица персоны
- **Аргументация:** почему такое решение
- **Возражения:** список конкретных барьеров
- **Что бы убедило:** что добавить в оффер

### Шаг 5: Отчёт
Интерактивный отчёт:
- Heatmap (персоны × офферы)
- Winners (лучший оффер для каждой персоны)
- Insights (ключевые паттерны)
- Стратегия (сегменты + рекомендации)
- Детали (раскрываемые карточки с полной аргументацией)

---

## 4. Архитектура

### Stack

| Слой | Технология | Обоснование |
|---|---|---|
| Frontend | Next.js 14+ (App Router) | SSR, API routes в одном проекте |
| UI | Tailwind + shadcn/ui | Быстрый красивый UI |
| Auth | NextAuth.js + Prisma Adapter | Email+password (MVP), Google OAuth (post-MVP) |
| DB | PostgreSQL | На VPS, надёжно |
| AI | OpenRouter API | Claude/GPT/Gemini через один endpoint |
| Очередь | Redis + BullMQ | Фоновые задачи на том же VPS |
| Мониторинг | Sentry + pino logger | Ошибки, performance, логи worker |
| Хостинг | RUVDS (VPS) + Docker | Российский хостинг, Docker Compose |
| Платежи | ЮKassa | Российские платежи, подписки |

### Модель данных

```
User (+ NextAuth: Account, Session, VerificationToken)
  ├── plan, planExpiresAt
  └── Projects[]
        ├── name, description, niche
        ├── Personas[]
        │     └── name, age, psychotype, pains, triggers, budget, experience
        ├── Offers[]
        │     └── headline, body, strategy_type
        └── TestRuns[]
              ├── created_at, status, model_used, prompt_version
              └── PersonaResponses[]
                    └── persona_id, offer_id, decision, confidence,
                        perceived_value, emotion, emotion_intensity,
                        first_reaction, reasoning, objections[], convincers
                        @@unique([testRunId, personaId, offerId])
```

Лимит тестов считается динамически: `COUNT(TestRun WHERE userId=X AND createdAt >= startOfMonth)`.

### Безопасность

- **Авторизация:** каждый API route проверяет `project.userId === session.userId`
- **Rate limiting:** `rate-limiter-flexible` на Redis — 30 req/min на API, 3 теста/мин на прогон, 3 генерации персон/день на Free
- **Input validation:** niche <= 500 символов, headline <= 200, body <= 2000. Zod-схемы на всех API endpoints
- **Prompt injection:** пользовательский ввод оборачивается в маркеры `<user_input>...</user_input>` + инструкция в промпте игнорировать любые команды внутри маркеров
- **Санитизация:** offer text выводится только через React JSX (автоматическое экранирование), прямая вставка HTML запрещена
- **API ключи:** OpenRouter key только в серверном `.env`, никогда не передаётся на клиент
- **CSRF:** NextAuth включает CSRF protection по умолчанию

### Асинхронность

Прогон теста — не мгновенный (8 персон × N офферов = 8×N API-вызовов).
- Пользователь нажимает «Запустить» → видит прогресс-бар
- Результаты появляются по мере готовности (polling каждые 2 сек)
- Можно закрыть вкладку и вернуться
- Параллельность: до 5 API-вызовов одновременно (лимит OpenRouter)
- OpenRouter rate limiting: concurrency=5, retry с exponential backoff

### Мониторинг

- **Sentry:** ошибки фронтенда и API, performance tracing
- **pino:** структурированные логи worker (каждый API-вызов, время, ошибки)
- **Docker healthchecks:** ping endpoint для next-app, redis-cli ping, pg_isready
- **Cron-алерт:** если worker не обработал задачу >5 мин → Telegram-уведомление

### Бэкапы

- PostgreSQL: `pg_dump` ежедневно в cron → хранение 7 последних на VPS + копия на S3/Selectel
- Redis: AOF persistence (`--appendonly yes` в docker-compose), RDB snapshots как дополнение

---

## 5. Экраны

### 5.1 Dashboard
- Список проектов (карточки)
- Последние тесты
- Использование лимита подписки (прогресс-бар)
- CTA: «Создать проект»
- **Пустое состояние:** «Создайте первый проект — опишите нишу, и AI сгенерирует персоны для тестирования ваших офферов»

### 5.2 Проект
- Описание ниши (редактируемое)
- Вкладки: Персоны | Офферы | Тесты | Отчёты

### 5.3 Персоны
- Сетка карточек персон
- Кнопки: «Сгенерировать» / «Из библиотеки» / «Добавить вручную»
- Клик → модалка с полным профилем (редактируемым)
- **Пустое состояние:** «Нажмите "Сгенерировать" — AI создаст 6 персон под вашу нишу»

### 5.4 Офферы
- Список текстов офферов
- Кнопки: «Добавить вручную» / «Сгенерировать варианты»
- При генерации: описать продукт → AI предлагает 5-7 стратегий
- **Пустое состояние:** «Добавьте хотя бы 2 оффера, чтобы сравнить их эффективность»

### 5.5 Отчёт
- Heatmap (матрица решений с цветовой кодировкой)
- Winners (таблица лучших офферов по персонам)
- Insights (карточки с ключевыми выводами)
- Стратегия (сегменты аудитории + рекомендуемые офферы)
- Детали (раскрываемые карточки с полной аргументацией)
- Real-time прогресс: карточки «загораются» по мере получения ответов
- **Состояние ошибки:** если AI не ответил по конкретной паре — карточка с меткой «Ошибка, повторить?»

### 5.6 Библиотека персон (post-MVP)
- Каталог готовых наборов по нишам (бьюти, e-com, еда, SaaS, образование)
- Превью набора → «Использовать в проекте»

### 5.7 A/B история (post-MVP)
- Таймлайн тестов внутри проекта
- График: средний value по итерациям
- Сравнение двух прогонов side-by-side

### 5.8 Онбординг (MVP)
- При первом входе: демо-проект «Кофейня» с 4 готовыми персонами и 3 офферами
- Демо-тест использует **предзаписанные результаты** (без реальных API-вызовов) — экономия ~$0.05 на каждую регистрацию
- Кнопка «Посмотреть демо-отчёт» → мгновенный результат
- После демо: «Создайте свой проект и запустите настоящий тест»
- **Loading states:** skeleton-карточки при генерации персон (5-10 сек), spinner на кнопке «Запустить тест»

---

## 6. AI Engine

### Параметры моделей

| Задача | Модель | Temperature | Max tokens |
|---|---|---|---|
| Генерация персон | claude-3.5-sonnet | 0.7 | 4096 |
| Оценка оффера | claude-3-haiku | 0.3 | 2048 |
| Генерация инсайтов | claude-3.5-sonnet | 0.5 | 2048 |

Низкий temperature для оценки = более стабильные, воспроизводимые результаты.
Высокий для генерации = разнообразие персон.

### Версионирование промптов

Каждый TestRun хранит `promptVersion: string` (e.g., `"eval-v2"`, `"persona-gen-v3"`).
При изменении промпта — инкрементировать версию. Старые результаты остаются сопоставимыми внутри одной версии.

### Валидация AI-ответов

1. Парсинг JSON: try/catch + retry (до 2 раз) с инструкцией «верни валидный JSON»
2. Проверка полей: decision in enum, confidence in [0,1], perceivedValue in [0,10]
3. Если после 2 retry невалидно → статус `FAILED` для этой пары, пользователь видит «Повторить?»
4. При retry используется та же модель, но с явной инструкцией в промпте: «Ответь ТОЛЬКО JSON без пояснений»

### Мультиязычность

MVP: только русский (промпты и персоны на русском).
Post-MVP: определять язык описания ниши → генерировать персоны и оценки на том же языке.

---

## 7. Монетизация

### Тарифы

| | Free | Pro | Agency |
|---|---|---|---|
| Цена | 0₽ | 1 990₽/мес | 5 990₽/мес |
| Проекты | 1 | 10 | Безлимит |
| Тесты/мес | 3 | 50 | 300 |
| Персоны/проект | 6 | 12 | 20 |
| Офферы/тест | 3 | 10 | 20 |
| AI-модели | 1 (haiku) | Все | Все |
| Библиотека персон | Базовая | Полная | Полная |
| A/B история | Нет | Да | Да |
| Экспорт PDF | Нет | Да | Да |
| Share-ссылки | Нет | Да | Да + white-label |

### Unit Economics (полная)

**Переменные расходы (на 1 Pro-подписчика/мес):**
- OpenRouter API: ~30 тестов x 8 персон x $0.01 = $2.40 (~240 руб)

**Постоянные расходы:**
- VPS RUVDS: ~2 000 руб/мес
- Домен: ~125 руб/мес (1 500 руб/год)
- Sentry: 0 руб (free tier, 5k events/мес)
- Итого: ~2 125 руб/мес

**Точка безубыточности (инфра):** 2 Pro-подписчика (2 x 1990 = 3980 руб > 2125 + 480 руб API)

**Расход на демо-онбординг:** 0 руб (предзаписанные результаты, без API-вызовов).

**Стратегия привлечения первых клиентов:**
- Посты в маркетинговых Telegram-каналах (бесплатно)
- Кейсы: «протестировал 7 офферов для бьюти-студии за 5 минут»
- Демо на waitlist-подписчиках → word of mouth

**Retention (почему платят каждый месяц):**
- Маркетолог запускает 5-15 креативов/мес → каждый нужно протестировать
- Новые офферы под акции, сезоны, праздники
- A/B история (post-MVP): ценность растёт со временем — видно какие подходы работали
- Рефрейм: это не одноразовый инструмент, а часть процесса запуска рекламы

---

## 8. Метрики успеха

| Метрика | Цель (3 мес после запуска) |
|---|---|
| Регистрации | 200 |
| Free → Pro конверсия | >= 5% (10 платящих) |
| Retention Pro (месяц 2) | >= 60% |
| Тестов/мес (все пользователи) | 500+ |
| NPS (опрос) | >= 40 |

**Аналитика (MVP):** простые счётчики в БД. Post-MVP: Posthog или Plausible.

---

## 9. MVP Scope

**Что входит в MVP:**
- Регистрация (email + пароль)
- Создать проект → описать нишу
- AI-генерация персон (6 штук)
- Ввод офферов вручную (до 5)
- Прогон теста с прогресс-баром
- Отчёт: heatmap + winners + insights
- Free-тариф (3 теста/мес)
- Онбординг: демо-проект «Кофейня»
- Мониторинг: Sentry + health checks
- Бэкапы: pg_dump ежедневно

**Что НЕ входит в MVP:**
- ЮKassa / платные тарифы (добавить после валидации)
- AI-генерация офферов
- Библиотека персон
- A/B история
- Экспорт PDF
- Share-ссылки
- Командный доступ
- Мультиязычность

---

## 10. Деплой

```
Docker Compose на RUVDS:
├── next-app (Next.js) — healthcheck: curl localhost:3000/api/health
├── postgres (PostgreSQL 16) — healthcheck: pg_isready
├── redis (Redis 7) — healthcheck: redis-cli ping
├── worker (BullMQ worker) — healthcheck: custom ping endpoint
└── nginx (reverse proxy + SSL via certbot)
```

CI/CD: GitHub Actions → docker build (multi-stage) → push to GHCR → SSH deploy to RUVDS.
Rollback: `docker compose up -d --pull=always` с предыдущим тегом образа.
Бэкапы: cron job на VPS → pg_dump → gzip → хранение 7 дней.
